<% display_only ||= false %>
<div data-hook="admin_return_authorization_form_fields">
  <table class="table table-bordered index return-items-table">
    <thead>
      <tr data-hook="rma_header">
        <th>
          <% if @return_authorization.allow_return_item_changes? && @return_authorization.new_record? %>
            <%= check_box_tag 'select-all', '0', false, { class: "#{all_item_returned?}" } %>
          <% end %>
        </th>
        <th><%= Spree.t(:product) %></th>
        <th><%= Spree.t(:state) %></th>
        <th><%= Spree.t(:charged) %></th>
        <th><%= Spree.t(:refund_amount) %></th>
        <th><%= Spree.t(:return_options) %></th>
        <th><%= Spree.t(:exchange_for) %></th>
      </tr>
    </thead>
    <tbody>
      <% grouped_return_items_by_shipment(@form_return_items).each do |shipment, return_items| %>
        <% if shipment.shipped? %>
          <% if return_items.any?(&:returnable?) %>
            <tr>
              <td></td>
              <td colspan="7" class="font-weight-bold"><%= Spree.t(:from) %> <span><%= shipment.stock_location.name %></span></td>
            </tr>
          <% end %>

          <%= f.fields_for :return_items, return_items do |item_fields| %>
            <% return_item = item_fields.object %>
            <% inventory_unit = return_item.inventory_unit %>

            <% editable ||= inventory_unit.shipped? && @return_authorization.allow_return_item_changes? && !return_item.reimbursement && line_item_returnable?(inventory_unit.line_item) && @return_authorization.new_record? %>

            <% if return_item.returnable? %>
              <tr>
                <td class="inventory-unit-checkbox">
                  <% if editable %>
                    <%= item_fields.hidden_field :inventory_unit_id %>
                    <%= item_fields.check_box :_destroy, { checked: return_item.persisted?, class: 'add-item', "data-price" => return_item.pre_tax_amount, readonly: true }, '0', '1' %>
                  <% elsif @return_authorization.persisted? %>  <!-- show checkbox only for show -->
                    <%= item_fields.check_box :_destroy, { checked: return_item.persisted?, class: 'add-item', "data-price" => return_item.pre_tax_amount, readonly: true, disabled: 'disabled' }, '0', '1' %>
                  <% end %>
                </td>
                <td>
                  <div class="variant-name"><%= inventory_unit.variant.name %></div>
                  <div class="variant-options"><%= inventory_unit.variant.options_text %></div>
                </td>
                <td><%= inventory_unit.state.humanize %></td>
                <td>
                  <% return_item.set_default_pre_tax_amount %>  <!-- needed when form has errors, and object loses its value -->
                  <%= return_item.display_pre_tax_amount %>
                </td>
                <td>
                  <%= item_fields.text_field :pre_tax_amount, { class: 'refund-amount-inputs form-control', disabled: true, readonly: true } %>
                </td>
                <td>
                  <% if editable %>
                    <%= radio_button_tag inventory_unit.id, 'refund', refund_for_item_return?(return_item), class: 'return-options' %>
                    <label for=<%= "#{ inventory_unit.id }_refund" %>><%= Spree.t(:refund) %></label>

                    <%= radio_button_tag inventory_unit.id, 'exchange_for', exchange_for_item_return?(return_item), class: 'return-options' %>
                    <label for=<%= "#{ inventory_unit.id }_exchange_for" %>><%= Spree.t(:exchange) %></label>
                  <% end %>
                </td>
                <td>
                  <% if editable %>
                    <% if return_item.exchange_processed? %>
                      <%= return_item.exchange_variant.exchange_name %>
                    <% else %>
                      <%= item_fields.collection_select :exchange_variant_id, return_item.eligible_exchange_variants, :id, :exchange_name, {}, { class: " return-item-exchange-selection form-control", disabled: display_only } %>
                    <% end %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </tbody>
  </table>

  <%= f.field_container :amount, class: ['alert alert-info'] do %>
    <%= Spree.t(:total_refund)%>  : <b id="total_pre_tax_refund"> <%= @return_authorization.display_pre_tax_total.to_html %></b>
  <% end %>

  <%= f.field_container :reason, class: ['form-group'] do %>
    <%= f.label :reason, Spree.t(:reason) %>

    <%= f.select :return_authorization_reason_id, @return_authorization_reasons.collect{ |r|[r.name, r.id] }, { include_blank: true }, { class: 'form-control add-item', "data-placeholder" => Spree.t(:select_a_return_authorization_reason), disabled: display_only } %>
    <%= f.error_message_on :reason %>
  <% end %>

  <%= f.field_container :memo, class: ['form-group'] do %>
    <%= f.label :memo, Spree.t(:memo) %>
    <%= f.text_area :memo, class: 'form-control', disabled: display_only %>
    <%= f.error_message_on :memo %>
  <% end %>
</div>

<% if Spree::Config[:expedited_exchanges] %>
  <div class="expedited-exchanges-warning"><%= Spree.t(:expedited_exchanges_warning, days_window: Spree::Config[:expedited_exchanges_days_window]) %></div>
<% end %>
